#!/bin/sh
# Pager <- Vim: https://vim.fandom.com/wiki/Using_vim_as_a_man-page_viewer_under_Unix
# check size <- https://unix.stackexchange.com/questions/245064/what-is-the-best-way-to-pipe-the-output-of-a-command-through-a-pager-if-and-onl
# Require perl, tput (in ncurses-utils)

unset PAGER


# PAGER bash example
man_print() {
    while read line
    do
      echo "$line"
    done 
}


# PAGER smallest
man_cat() { cat -; }


# PAGER for manpages (prefix by col)
man_col(){
    col -b -x |
    vim -R \
    --not-a-term \
    -c 'set ft=man nomod nolist' \
    -c 'map q :q<CR>' \
    -c 'map <SPACE> <C-D>' -c 'map b <C-U>' \
    -c 'set foldlevel=30'  \
    -c 'nmap K :Man <C-R>=expand(\\\"<cword>\\\")<CR><CR>' \
    -
}


# PAGER for git diff files (Ansi-Escaped)
man_ansi() {
    vim -R \
    -c 'map q :q<CR>' \
    -c 'map <SPACE> <C-D>' -c 'map b <C-U>' \
    -c 'set foldlevel=30' \
    -c 'packadd ansiesc' -c 'AnsiEsc' \
    -
}


# Discrimintate size of stdin to pipe in (vim | less | cat)
man_select(){
    buffer=$(mktemp)
    rows="${LINES:=$(tput lines)}"
    cols="${COLUMNS:=$(tput cols)}"
    while true; do
        # Read
        IFS= read -r some_data
        eof=$?        # 1 if EOF, 0 if normal, successful read.

        # Write to buffer
        printf "%s" "$some_data" >> "$buffer"
        if [ "$eof" = 0 ]
        then
            printf "\n" >> "$buffer"
        fi

        # Check if size of buffer fits
        n_virt=$(fold -w"$cols" "$buffer" | wc -l)
        if [ "$n_virt" -lt "$rows" ]

        # If Small
        then
            if [ "$eof" != 0 ]
            then
                cat "$buffer"
            else
                # If not finished continue reading
                continue
            fi

        # Elif Large
        else
            # But with EOF so cat
            if [ "$eof" != 0 ]
            then
                "${PAGER:="less"}" < "$buffer"
                # The above is equivalent to
                # cat "$buffer"   | "${PAGER:="less"}"
                # … but that’s a UUOC.
            # So work
            else
                # Choose PAGER accroding to AnsiEsc detection
                man_cmd="man_col"
                perl -ne 'exit 42 if m/\e\[[0-9;]*[mG]/' "$buffer"
                [ $? = 42 ] && man_cmd="man_ansi"
                # Concatenate buffer (size of the screen) and stdin (-)
                cat "$buffer" - |
                # Go in Vim
                "${PAGER:="$man_cmd"}"
            fi
        fi
        break
    done
    rm "$buffer"
}

man_select
